---
title: "Predictions by Game instead of Season"
author: "Philip Bulsink"
date: '2018-09-26'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Predictions by Game instead of Season}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(HockeyModel)
library(MLmetrics)
knitr::opts_chunk$set(echo = TRUE)

elo.ll.1617 <- 0.698528636409134
elo.acc.1617 <- 0.459349593495935
elo.ll.1718 <- 0.7056434
elo.acc.1718 <-0.4539732
dc.ll.1617 <- 0.669333230168212
dc.acc.1617 <- 0.591056910569106
dc.ll.1718 <- 0.6758298
dc.acc.1718 <- 0.5908733
```
```{r data_prep, eval = FALSE, include = FALSE}
scores15<-HockeyModel::scores
scores15<-scores15[scores15$Date < "2016-08-01",]
results16<-HockeyModel::scores
results16<-results16[results16$Date > "2016-08-01",]
results16<-results16[results16$Date < "2017-08-01",]
schedule16<-results16[,c("Date", "HomeTeam", "AwayTeam")]
schedule16<-schedule16[c(1:1230),]
schedule16$Date<-as.character(schedule16$Date)

scores16<-HockeyModel::scores
scores16<-scores16[scores16$Date < "2016-08-01",]
results17<-HockeyModel::scores
results17<-results17[results17$Date > "2017-08-01",]
results17<-results17[results17$Date < "2018-08-01",]
schedule17<-results17[,c("Date", "HomeTeam", "AwayTeam")]
schedule17<-schedule17[c(1:1271),]
schedule17$Date<-as.character(schedule17$Date)
```

## Evaluating by Game instead of by Season

Peformance measures can be done by game, instead of by season. 

The first metrics analysis I performed looked at results for a coming season. This is fun, but less useful in February when we start looking at how a team is doing this year instead of last. 

Lets look at the performance of Elo and Dixon Coles (log loss and accuracy) for the 2016-2017 season.

```{r elo1617, eval = FALSE}
elo<-HockeyModel:::calculateEloRatings(scores15, k=8, mean_value = 1505, new_teams = 1300, regress_strength = 3, home_adv = 35)

eloResults<-results16[c(1:1230),]
eloResults$pHome <- NA
eloResults$pAway <- NA

for(gameday in unique(schedule16$Date)){
  todayp<-todayELO(today = gameday, elos = elo, schedule = schedule16, pDraw = 0)
  
  eloResults[eloResults$Date == gameday,]$pHome<-todayp$HomeWin
  eloResults[eloResults$Date == gameday,]$pAway<-todayp$AwayWin
  
  todayscores<-results16[results16$Date == gameday, ]
  elo<-HockeyModel:::calculateEloRatings(todayscores[,c('Date','HomeTeam','AwayTeam','HomeGoals','AwayGoals', 'Result')], ratings_history = elo, k=8, mean_value = 1505, new_teams = 1300, regress_strength = 3, home_adv = 35)
}
elo.ll.1617 <- LogLoss(y_pred = eloResults$pHome, y_true = round(eloResults$Result))
elo.acc.1617 <- Accuracy(y_pred = round(eloResults$pHome), y_true = round(eloResults$Result))
```

```{r elo1718, echo=FALSE, eval = FALSE}
eloResults<-results17[c(1:1271),]
eloResults$pHome <- NA
eloResults$pAway <- NA

for(gameday in unique(schedule17$Date)){
  todayp<-todayELO(today = gameday, elos = elo, schedule = schedule17, pDraw = 0)
  
  eloResults[eloResults$Date == gameday,]$pHome<-todayp$HomeWin
  eloResults[eloResults$Date == gameday,]$pAway<-todayp$AwayWin
  
  todayscores<-results17[results17$Date == gameday, ]
  elo<-HockeyModel:::calculateEloRatings(todayscores[,c('Date','HomeTeam','AwayTeam','HomeGoals','AwayGoals', 'Result')], ratings_history = elo, k=8, mean_value = 1505, new_teams = 1300, regress_strength = 3, home_adv = 35)
}
elo.ll.1718 <- LogLoss(y_pred = eloResults$pHome, y_true = round(eloResults$Result))
elo.acc.1718 <- Accuracy(y_pred = round(eloResults$pHome), y_true = round(eloResults$Result))
```
So, for 2016-2017 we get a Log Loss of `r round(elo.ll.1718, 4)` and Accuracy of `r round(elo.acc.1718, 4)`. Similarly, for 2017-2018, we get a Log Loss of `r round(elo.ll.1718, 4)` and Accuracy of `r round(elo.acc.1718, 4)`.

With this same technique, we'll analyze Dixon-Coles.
```{r trimScores, eval = FALSE}
scores15<-scores15[scores15$Date > "2005-08-01",]
scores15<-droplevels(scores15)
scores16<-scores16[scores16$Date > "2006-08-01",]
scores16<-droplevels(scores16)
```

```{r dc1617, eval = FALSE}
dc.m <- HockeyModel:::getM(scores = scores15, currentDate = as.Date('2016-10-12'))
dc.rho <- suppressWarnings(HockeyModel:::getRho(scores = scores15, m = dc.m))

dcResults<-results16[c(1:1230),]
dcResults$pHome <- NA
dcResults$pAway <- NA
dcResults$pDraw <- NA

for(gameday in unique(schedule16$Date)){
  todayp<-todayDC(today = as.Date(gameday), schedule = schedule16, m = dc.m, rho = dc.rho)
  
  dcResults[dcResults$Date == as.Date(gameday),]$pHome<-todayp$HomeWin
  dcResults[dcResults$Date == as.Date(gameday),]$pAway<-todayp$AwayWin
  dcResults[dcResults$Date == as.Date(gameday),]$pDraw<-todayp$Draw
  
  todayscores<-rbind(scores15, results16[results16$Date <= as.Date(gameday), ])
  dc.m <- HockeyModel:::getM(scores = todayscores, currentDate = as.Date(gameday))
}

dc.ll.1617 <- LogLoss(y_pred = dcResults$pHome+dcResults$pDraw*0.5, y_true = round(dcResults$Result))
dc.acc.1617 <- Accuracy(y_pred = round(dcResults$pHome+dcResults$pDraw*0.5), y_true = round(dcResults$Result))

```

```{r dc1718, echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}
dc.m <- HockeyModel:::getM(scores = scores16, currentDate = as.Date('2017-10-04'))
dc.rho <- suppressWarnings(HockeyModel:::getRho(scores = scores16, m = dc.m))

dcResults<-results17[c(1:1271),]
dcResults$pHome <- NA
dcResults$pAway <- NA
dcResults$pDraw <- NA

for(gameday in unique(schedule17$Date)){
  todayp<-todayDC(today = as.Date(gameday), schedule = schedule17, m = dc.m, rho = dc.rho)
  
  dcResults[dcResults$Date == as.Date(gameday),]$pHome<-todayp$HomeWin
  dcResults[dcResults$Date == as.Date(gameday),]$pAway<-todayp$AwayWin
  dcResults[dcResults$Date == as.Date(gameday),]$pDraw<-todayp$Draw
  
  todayscores<-rbind(scores16, results17[results17$Date <= as.Date(gameday), ])
  dc.m <- HockeyModel:::getM(scores = todayscores, currentDate = as.Date(gameday))
}
dc.ll.1718 <- LogLoss(y_pred = dcResults$pHome+dcResults$pDraw*0.5, y_true = round(dcResults$Result))
dc.acc.1718 <- Accuracy(y_pred = round(dcResults$pHome+dcResults$pDraw*0.5), y_true = round(dcResults$Result))
```

So for 2016-2017, we get  Log Loss of `r round(dc.ll.1617, 4)` and accuracy of `r round(dc.acc.1617, 4)`
And likewise for 2017-2018, we get a Log Loss of `r round(dc.ll.1718, 4)` and accuracy of `r round(dc.acc.1718, 4)`. Much better than Elo prediction!!
